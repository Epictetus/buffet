#!/usr/bin/env ruby

$LOAD_PATH.unshift(File.expand_path(File.dirname(__FILE__) + '/../lib'))

require 'fileutils'
require 'spec'
require 'spec/runner/command_line'
require 'buffet/augmented_text_formatter'

# NOTE: ARGV is used by the spec runner. If I leave the drb server address
# in ARGV, rspec will think it's an argument to the test runner.
buffet_server = DRbObject.new_with_uri(ARGV.pop)

Spec::Runner::Formatter::AugmentedTextFormatter.buffet_server = buffet_server

FileUtils.mkdir_p('./tmp')
while file = buffet_server.next_file
  stdout = File.open("./tmp/buffet.out.log", 'a')
  stderr = File.open("./tmp/buffet.error.log", 'a')

  success = ::Spec::Runner::CommandLine.run(
     ::Spec::Runner::OptionParser.parse(
       ['--format', 'Spec::Runner::Formatter::AugmentedTextFormatter', file], stderr, stdout
     )
   )

end
